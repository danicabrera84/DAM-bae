CREATE DATABASE EMPRESA
GO

USE EMPRESA

CREATE TABLE TCENTR
       (NUMCE INTEGER      NOT NULL,
        NOMCE VARCHAR(25)  NOT NULL,
        SENAS VARCHAR(25)  NOT NULL,
        PRIMARY KEY(NUMCE));

/* Creación de la tabla TDEPTO */

CREATE TABLE TDEPTO 
       (NUMDE INTEGER      NOT NULL,
        NUMCE INTEGER,
        DIREC INTEGER,
        TIDIR CHAR(1),
        PRESU DECIMAL(3,0) NOT NULL,
        DEPDE INTEGER,
        NOMDE VARCHAR(20)  NOT NULL,
        PRIMARY KEY(NUMDE));

/* Creación de la tabla TEMPLE */

CREATE TABLE TEMPLE
       (NUMEM INTEGER      NOT NULL,
        NUMDE INTEGER      NOT NULL,
        EXTEL SMALLINT     NOT NULL,
        FECNA DATE         NOT NULL,
        FECIN DATE         NOT NULL,
        SALAR DECIMAL(4,0) NOT NULL,
        COMIS DECIMAL(4,0),
        NUMHI SMALLINT     NOT NULL,
        NOMEM VARCHAR(20)  NOT NULL,
        PRIMARY KEY(NUMEM));



/* Carga de la tabla TCENTR */

INSERT INTO TCENTR (NUMCE, NOMCE, SEnAS)
       VALUES (10, 'SEDE CENTRAL', 'C. ALCALA, 820, MADRID');
INSERT INTO TCENTR (NUMCE, NOMCE, SEnAS)
       VALUES (20, 'RELACION CON CLIENTES', 'C. ATOCHA, 405, MADRID');
INSERT INTO TCENTR (NUMCE, NOMCE, SEnAS)
       VALUES (50, 'ALMACEN', 'C. LAVAPIES, 520, MADRID');


/* Carga de la tabla TDEPTO */

INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
       VALUES (100,10,260,'P',120,NULL,'DIRECCION GENERAL');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
       VALUES (110,20,180,'P',150,100,'DIRECCION COMERCIAL');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (111,20,180,'F',110,110,'SECTOR INDUSTRIAL');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (112,20,270,'P',90,110,'SECTOR SERVICIOS');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (120,10,150,'F',30,100,'ORGANIZACION');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (121,10,150,'P',20,120,'PERSONAL');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (122,10,350,'P',60,120,'PROCESO DE DATOS');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (130,10,310,'P',20,100,'FINANZAS');
INSERT INTO TDEPTO (NUMDE, NUMCE, DIREC, TIDIR, PRESU, DEPDE, NOMDE)
        VALUES (123,NULL,150,'F',100,121,'PERSONAL CONTRATADO');


/* Carga de la tabla TEMPLE */

INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (110,121,350,'1929/11/10','1950/02/15',310,NULL,3,'PONS, CESAR');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (120,112,840,'1935/06/09','1968/10/01',350,110,1,'LASA, MARIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (130,112,810,'1945/09/09','1969/02/01',290,110,2,'TEROL, LUCIANO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (150,121,340,'1930/08/10','1948/01/15',440,NULL,0,'PEREZ, JULIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (160,110,740,'1939/07/09','1968/11/11',310,110,2,'AGUIRE, AUREO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (180,110,508,'1934/10/18','1956/03/18',480,50,2,'PEREZ, MARCOS');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (190,121,350,'1932/05/12','1962/02/11',300,NULL,4,'VEIGA, JULIANA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (210,100,200,'1940/08/28','1959/01/22',380,NULL,2,'GALVEZ, PILAR');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (240,110,760,'1942/02/26','1966/02/24',280,100,3,'SANZ, LAVINIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (250,100,250,'1946/10/27','1967/03/01',450,NULL,0,'ALBA, ADRIANA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (260,100,220,'1943/12/03','1968/07/12',720,NULL,6,'LOPEZ, ANTONIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (270,112,800,'1945/05/21','1966/09/10',380,80,3,'GARCIA, OCTAVIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (280,130,410,'1948/01/11','1971/10/08',290,NULL,5,'FLOR, DOROTEA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (285,122,620,'1949/10/25','1968/02/15',380,NULL,0,'POLO, OTILIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (290,120,910,'1947/11/30','1968/02/14',270,NULL,3,'GIL, GLORIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (310,130,480,'1946/11/21','1971/01/15',420,NULL,0,'GARCIA, AUGUSTO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (320,122,620,'1957/12/25','1978/05/02',405,NULL,2,'SANZ, CORNELIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (330,112,850,'1948/08/19','1972/03/01',280,90,0,'DIEZ,AMELIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (350,122,610,'1949/04/13','1984/09/10',450,NULL,1,'CAMPS, AURELIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (360,111,750,'1958/10/29','1968/10/10',250,100,2,'LARA,DORINDA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (370,121,360,'1967/06/22','1987/01/20',190,NULL,1,'RUIZ, FABIOLA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (380,112,880,'1968/03/30','1988/01/01',180,NULL,0,'MARTIN, MICAELA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (390,110,500,'1966/02/19','1986/10/08',215,NULL,1,'MORAN, CARMEN');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (400,111,780,'1969/08/18','1987/11/01',185,NULL,0,'LARA, LUCRECIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (410,122,660,'1968/07/14','1988/10/13',175,NULL,0,'MUnOZ, AZUCENA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (420,130,450,'1966/10/22','1988/11/19',400,NULL,0,'FIERRO, CLAUDIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (430,122,650,'1967/10/26','1988/11/19',210,NULL,1,'MORA, VALERIANA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (440,111,760,'1966/09/26','1986/02/02',210,100,0,'DURAN, LIVIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (450,112,880,'1966/10/21','1986/02/28',210,100,0,'PEREZ, SABINA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (480,111,760,'1965/04/04','1986/02/28',210,100,1,'PINO, DIANA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (490,112,880,'1964/06/06','1988/01/01',180,100,0,'TORRES, HORACIO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (500,111,750,'1965/10/08','1987/01/01',200,100,0,'VAZQUEZ, HONORIA');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (510,110,550,'1966/05/04','1986/11/01',200,NULL,1,'CAMPOS, ROMULO');
INSERT INTO TEMPLE (NUMEM, NUMDE, EXTEL, FECNA, FECIN, SALAR, COMIS, NUMHI, NOMEM)
        VALUES (550,111,780,'1970/01/10','1988/01/21',100,120,0,'SANTOS, SANCHO');


		Create view VEMPLE1 as select * from TEMPLE where SALAR >200
		GO

		Create view VEMPLE2 as select numem, nomem from TEMPLE where salar > 200
		GO

		Create view VEMPLE3 as select nomem as NOMBRE , numem as ID from VEMPLE2 where nomem like '%PEREZ%'
		GO

		Create view VEMPLE4 as select numem, nomem, numde, year (getdate())-year(fecna) as
        edad, year (getdate())-year(fecin) as años_servicio from VEMPLE1
		GO


Create view VEMPLE5 as select min(edad) as edad_minima, max (edad) as edad_maxima, avg(
edad) as edad_media from VEMPLE4 group by numde
GO

CREATE VIEW DIRECTORIO as select numem,nomem,E.numde,nomde,extel
FROM TEMPLE E INNER JOIN TDEPTO D ON E.numde=D.numde
GO

create table TIDPER (idpem varchar (10) not null primary key,
numemp int not null unique)

create view VistaDir as select temple.* from TIDPER,TEMPLE
where idpem=system_user and numde=(select NUMDE from TEMPLE where
TIDPER.NUMEMP=TEMPLE.NUMEM) and TIDPER.NUMEMP=any(select DIREC from TDEPTO)
GO

grant select on VistaDir to public



create view VTDEPTO as select NUMDE, NUMCE, DIREC, TIDIR, DEPDE, NOMDE from TDEPTO ;
GO
grant select on VTDEPTO to public

create view VEMCOM as select NUMEM, NUMDE, EXTEL, NOMEM from TEMPLE where COMIS is not null ;
GO
grant select on VEMCOM to public




create view VJUBIL1 as select * from TEMPLE where year (getdate()) - year (fecna) = 65
GO
grant select on VJUBIL1 to U0150

CREATE VIEW DANI AS SELECT NUMDE FROM TEMPLE

create view VJUBIL2 as select TEMPLE.* from TIDPER, TEMPLE,TDEPTO where idpem=SYSTEM_USER 
and TIDPER.NUMEMP=direc and NOMDE='personal'
and YEAR(getdate())-YEAR(fecna) =65
GO
grant select on VJUBIL2 to public


create view VJUBIL3 as select J.* from TIDPER I, TEMPLE E, TDEPTO D, TEMPLE J
where idpem = SYSTEM_USER and I.numemp = E.NUMEM and E.NUMDE = D.NUMDE and
D.NOMDE='personal' and year (getdate()) - year (E.FECNA) = 65 ;
GO
grant select on VJUBIL3 to public

SELECT * FROM TEMPLE

--Al ser una tabla más extensa creamos los siguientes índices para poder localizar mejor los
--datos número de empleado, salario y fecha de nacimiento

CREATE INDEX IND_NUMEM ON TEMPLE(NUMEM)
CREATE INDEX IND_SALAR on TEMPLE(SALAR)
CREATE INDEX IND_FECNA on TEMPLE(FECNA)
GO



SELECT * FROM TDEPTO

--Creamos el índice IND_NUMDE para poder localizar mejor el número de empleado

CREATE INDEX IND_NUMDE on TDEPTO(NUMDE)
GO

SELECT * FROM TCENTR

--En realidad al haber pocos datos no sería necesario crear un indice pero
-- crearemos el indice IND_NUMCE por si en un futuro se agregan nuevos datos
--a la tabla y asi localizar mejor el número de cada centro

CREATE INDEX IND_NUMCE ON TCENTR(NUMCE)
GO

select nomem,( salar + comis )from temple where numde = 112 order by nomem
GO

select avg (salar) as 'Salario medio', avg (year (getdate())- year(fecna) ) as 'Edad media'
from temple where comis is not null union select avg (salar), avg (year (getdate())- year(fecna) )from temple
where comis is null
GO

select NOMEM,( SALAR/NUMHI) as 'Cociente Salario-hijos','salario / hijos'as 'Salario o salario/hijos'
from TEMPLE where COMIS is null and NUMHI > 0 union select NOMEM, SALAR, 'salario' from TEMPLE
where COMIS is null and NUMHI = 0 order by NOMEM
GO

select NOMEM, (SALAR +COMIS) as 'SALARIO TOTAL' from TEMPLE E , TDEPTO D , TCENTR C where E.NUMDE = D.NUMDE 
and D.NUMCE = C.NUMCE and SENAS like '%atocha%' and SALAR > (select avg (SALAR)from TEMPLE where NUMDE = E.NUMDE)
 and comis is not null
order by NOMEM ASC

select NOMDE, sum (SALAR) + sum (COMIS) as'MASA SALARIAL TOTAL' from TEMPLE E,TDEPTO D
where D.NUMDE = E.NUMDE group by D.NUMDE,D.NOMDE having count (COMIS) > 0 union
select NOMDE, sum (SALAR) from TEMPLE E, TDEPTO D where D.NUMDE =E.NUMDE group by d.numde, d.nomde having 
count (COMIS) = 0 order by 1
GO

select NOMDE AS 'NOMBRE DEPARTAMENTO PRINCIPAL', NOMDE AS 'DEPENDE DE DEPARTAMENTO SECUNDARIO', 0 AS 'NIVEL'
from TDEPTO union select D0.NOMDE , D1.NOMDE, 1 from TDEPTO D0, TDEPTO D1 where D1.NUMDE = D1.DEPDE union
select D0.NOMDE, D2.NOMDE, 2 from TDEPTO D0, TDEPTO D1, TDEPTO D2 where D0.NUMDE = D1.DEPDE and D1.NUMDE = D2.DEPDE
union select D0.NOMDE, D3.NOMDE, 3 from TDEPTO D0, TDEPTO D1, TDEPTO D2, TDEPTO D3 where D0.NUMDE = D1.DEPDE and 
D1.NUMDE = D2.DEPDE and D2.NUMDE = D3.DEPDE union select D0.NOMDE, D4.NOMDE, 4 from TDEPTO D0, TDEPTO D1, TDEPTO D2, 
TDEPTO D3, TDEPTO D4 where D0.NUMDE = D1.DEPDE and D1.NUMDE = D2.DEPDE and D2.NUMDE = D3.DEPDE and D3.NUMDE = D4.DEPDE
ORDER BY NIVEL
GO

CREATE TABLE TTRASL
(NUMDE INTEGER      NOT NULL)
GO

select D.* from TDEPTO D, TTRASL T where D.NUMDE = T.NUMDE union select D.*from TDEPTO D where not exists 
(select *from TTRASL T where d.NUMDE = T.NUMDE)
GO

create synonym TRABAJADORES for TEMPLE
create synonym EMPLEADOS for TEMPLE
create synonym DEPARTAMENTOS for TDEPTO
create synonym DEPENDENCIA for TDEPTE
create synonym LUGAR for TCENTR
create synonym UBICACION for TCENTR
create synonym IDENTIFICADOR for TIDPER 
create synonym IDENT for TIDPER
GO

create synonym VISTA_EXT FOR VEMCOM
create synonym VISTA_CLASS_DPTO FOR VTDEPTO
GO

SELECT * FROM EMPLEADOS
SELECT * FROM EMPLEADOS WHERE COMIS>100
SELECT * FROM empleados where nomem like '%es%'
SELECT * FROM DEPARTAMENTOS
SELECT * FROM DEPARTAMENTOS WHERE DEPDE IS NOT NULL
SELECT NUMDE FROM DEPARTAMENTOS WHERE DIREC=260
SELECT * from ubicacion where numce=10
SELECT * From ubicacion where senas like '%820%'
GO

SELECT *from vista_class_dpto where TIDIR='F'
SELECT *from vista_ext where extel >700 and extel<900
go
